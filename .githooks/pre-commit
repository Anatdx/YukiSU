#!/usr/bin/env bash

# Pre-commit hook for YukiSU
# - 为所有已暂存的 C/C++ 源文件自动补全 #endif 注释
# - 然后运行 clang-format

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
CLANG_FORMAT_BIN="${CLANG_FORMAT_BIN:-clang-format}"
ENDIF_SCRIPT="$REPO_ROOT/.githooks/fix_endif_comments.py"

# 找出已暂存的 C/C++ 文件（新增/复制/修改）
STAGED_FILES=$(
  git diff --cached --name-only --diff-filter=ACM |
    grep -E '\.(c|cc|cpp|cxx|h|hh|hpp)$' || true
)

if [ -z "${STAGED_FILES}" ]; then
  echo "[pre-commit] No staged C/C++ files, nothing to do."
  exit 0
fi

echo "[pre-commit] Processing staged C/C++ files..."

# 1) 先跑 fix_endif_comments.py，自动补全/修正 #endif 注释
if [ -f "$ENDIF_SCRIPT" ]; then
  echo "[pre-commit] Adding/updating #endif comments..."
  for file in ${STAGED_FILES}; do
    if [ -f "$REPO_ROOT/$file" ]; then
      python3 "$ENDIF_SCRIPT" "$REPO_ROOT/$file"
    fi
  done
fi

# 2) 再跑 clang-format
if command -v "${CLANG_FORMAT_BIN}" >/dev/null 2>&1; then
  echo "[pre-commit] Running ${CLANG_FORMAT_BIN}..."
  for file in ${STAGED_FILES}; do
    if [ -f "$REPO_ROOT/$file" ]; then
      "${CLANG_FORMAT_BIN}" -i "$REPO_ROOT/$file"
    fi
  done
else
  echo "[pre-commit] ${CLANG_FORMAT_BIN} not found, skipping formatting." >&2
fi

# 3) 把修改后的文件重新加入暂存区
for file in ${STAGED_FILES}; do
  if [ -f "$REPO_ROOT/$file" ]; then
    git add "$REPO_ROOT/$file"
  fi
done

echo "[pre-commit] Done."
exit 0
