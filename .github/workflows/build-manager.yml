name: Build Manager

on:
  workflow_dispatch:
  push:
    branches: [ "main", "dev", "feat/**" ]
    paths:
      - '.github/workflows/build-manager.yml'
      - '.github/workflows/build-lkm.yml'
      - '.github/workflows/ksud.yml'
      - '.github/workflows/ksuinit.yml'
      - 'manager/**'
      - 'kernel/**'
      - 'userspace/**'
  pull_request:
    branches: [ "main", "dev" ]
    paths:
      - '.github/workflows/build-manager.yml'
      - '.github/workflows/build-lkm.yml'
      - '.github/workflows/ksud.yml'
      - '.github/workflows/ksuinit.yml'
      - 'manager/**'
      - 'kernel/**'
      - 'userspace/**'
  workflow_call:

jobs:
  build-lkm:
    uses: ./.github/workflows/build-lkm.yml
    secrets: inherit

  build-ksuinit:
    strategy:
      matrix:
        include:
          - target: aarch64-linux-android
          - target: x86_64-linux-android
          - target: armv7-linux-androideabi
    uses: ./.github/workflows/ksuinit.yml
    secrets: inherit
    with:
      target: ${{ matrix.target }}

  build-ksud:
    needs: [build-lkm, build-ksuinit]
    strategy:
      matrix:
        include:
          - target: aarch64-linux-android
            os: ubuntu-latest
          - target: x86_64-linux-android
            os: ubuntu-latest
          - target: armv7-linux-androideabi
            os: ubuntu-latest
    uses: ./.github/workflows/ksud.yml
    secrets: inherit
    with:
      target: ${{ matrix.target }}
      os: ${{ matrix.os }}

  build-manager:
    needs: build-ksud
    strategy:
      matrix:
        include:
          - abi: arm64-v8a
            ksud_artifact: ksud-aarch64-linux-android
          - abi: x86_64
            ksud_artifact: ksud-x86_64-linux-android
          - abi: armeabi-v7a
            ksud_artifact: ksud-armv7-linux-androideabi
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./manager

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup need_upload
        id: need_upload
        run: |
          if [ ! -z "${{ secrets.BOT_TOKEN }}" ]; then
            echo "UPLOAD=true" >> $GITHUB_OUTPUT
          else
            echo "UPLOAD=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine manager variant for telegram bot
        id: determine
        run: |
          echo "title=Manager" >> $GITHUB_OUTPUT
          echo "topicid=${{ vars.MESSAGE_THREAD_ID }}" >> $GITHUB_OUTPUT

      - name: Write key
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          if [ ! -z "${{ secrets.KEYSTORE }}" ]; then
            {
              echo KEYSTORE_PASSWORD='${{ secrets.KEYSTORE_PASSWORD }}'
              echo KEY_ALIAS='${{ secrets.KEY_ALIAS }}'
              echo KEY_PASSWORD='${{ secrets.KEY_PASSWORD }}'
              echo KEYSTORE_FILE='key.jks'
            } >> gradle.properties
            echo "${{ secrets.KEYSTORE }}" | base64 -d > key.jks
          fi

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Download ksud
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ksud_artifact }}
          path: ksud

      - name: Copy ksud to app jniLibs
        run: |
          mkdir -p app/src/main/jniLibs/${{ matrix.abi }}
          cp -f ../ksud/ksud app/src/main/jniLibs/${{ matrix.abi }}/libksud.so

      - name: Build with Gradle
        if: ${{ steps.determine.outputs.SKIP != 'true' }}
        run: ./gradlew assembleRelease --build-cache --no-daemon -PABI=${{ matrix.abi }}

      - name: Import GPG key
        if: ${{ github.event_name != 'pull_request' }}
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
          echo "$GPG_PRIVATE_KEY" > key.asc
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --import key.asc
          rm -f key.asc

      - name: Sign APK with GPG
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          cd app/build/outputs/apk/release
          for apk in *.apk; do
            if [ -f "$apk" ]; then
              echo "Signing $apk..."
              gpg --detach-sign --local-user an@anatdx.com --batch --yes --pinentry-mode loopback \
                --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
                --output "${apk}.sig" "$apk"
            fi
          done
          echo "Signatures created:"
          ls -lh *.sig || true

      - name: Upload build artifact
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: Manager-${{ matrix.abi }}
          path: |
            manager/app/build/outputs/apk/release/*.apk
            manager/app/build/outputs/apk/release/*.apk.sig

      - name: Upload mappings
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.determine.outputs.title }}-mappings-${{ matrix.abi }}"
          path: "manager/app/build/outputs/mapping/release/"

      - name: Upload to telegram
        if: matrix.abi == 'arm64-v8a' && github.event_name != 'pull_request' && steps.need_upload.outputs.UPLOAD == 'true' && steps.determine.outputs.SKIP != 'true'
        env:
          CHAT_ID: ${{ vars.CHAT_ID }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          MESSAGE_THREAD_ID: ${{ steps.determine.outputs.topicid }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TITLE: ${{ steps.determine.outputs.title }}
          BRANCH: ${{ github.ref_name }}
        run: |
          if [ ! -z "${{ secrets.BOT_TOKEN }}" ]; then
            export VERSION=$(git rev-list --count HEAD)
            APKS=$(find ./app/build/outputs/apk/release -name "*.apk")
            pip3 install telethon
            python3 $GITHUB_WORKSPACE/scripts/ksubot.py $APKS
          fi
