# Build HymoFS kernel module for one KMI + arch.
# arm64: DDK container (same as ddk-lkm).
# armv7/x86_64: manual kernel clone + build.
name: Build HymoFS Kernel Module

on:
  workflow_call:
    inputs:
      kmi:
        description: "KMI version"
        required: true
        type: string
      arch:
        description: "Target arch: arm64, armv7, x86_64"
        required: true
        type: string
      hymofs_ref:
        description: "HymoFS git ref (branch/tag/commit)"
        required: false
        default: "main"
        type: string
      ddk_release:
        description: 'DDK release version'
        required: false
        default: '20251104'
        type: string

jobs:
  build-arm64:
    name: Build hymofs arm64 ${{ inputs.kmi }}
    if: inputs.arch == 'arm64'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ylarod/ddk:${{ inputs.kmi }}-${{ inputs.ddk_release }}
      options: --privileged

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Clone HymoFS
        run: |
          git clone --depth 1 "https://github.com/Anatdx/HymoFS.git" hymofs_src
          (cd hymofs_src && git fetch --depth 1 origin "${{ inputs.hymofs_ref }}" && git checkout FETCH_HEAD 2>/dev/null || true)
          ls -la hymofs_src/src/

      - name: Generate version
        id: parse_version
        run: |
          COMMIT_NUM=$(cd hymofs_src && git rev-list --count HEAD)
          VERSION=$(echo "$COMMIT_NUM + 200" | bc)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Build hymofs_lkm.ko (DDK)
        run: |
          git config --global --add safe.directory /__w/YukiSU/YukiSU || true
          cd kernel

          echo "=== Building hymofs_lkm.ko for KMI: ${{ inputs.kmi }} (arm64) ==="
          make -C $KDIR M="$GITHUB_WORKSPACE/hymofs_src/src" CC=clang \
            CFLAGS_MODULE="-DHYMOFS_VERSION=\"0.1.${{ steps.parse_version.outputs.VERSION }}\"" \
            KBUILD_MODPOST_WARN=1 modules

          echo "=== Build completed ==="
          mkdir -p /github/workspace/out
          OUTPUT_NAME="${{ inputs.kmi }}_arm64_hymofs_lkm.ko"
          cp "$GITHUB_WORKSPACE/hymofs_src/src/hymofs_lkm.ko" "/github/workspace/out/$OUTPUT_NAME"

          echo "Copied to: /github/workspace/out/$OUTPUT_NAME"
          ls -la "/github/workspace/out/$OUTPUT_NAME"
          echo "Size: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"
          llvm-strip -d "/github/workspace/out/$OUTPUT_NAME"
          echo "Size after stripping: $(du -h "/github/workspace/out/$OUTPUT_NAME" | cut -f1)"

      - name: Install GPG
        run: apt-get update && apt-get install -y gnupg

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
          echo "$GPG_PRIVATE_KEY" > key.asc
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --import key.asc
          rm -f key.asc

      - name: Sign hymofs_lkm.ko with GPG
        run: |
          cd /github/workspace/out
          KO_FILE="${{ inputs.kmi }}_arm64_hymofs_lkm.ko"
          echo "Signing $KO_FILE..."
          gpg --detach-sign --local-user an@anatdx.com --batch --yes --pinentry-mode loopback \
            --passphrase "$GPG_PASSPHRASE" \
            --output "${KO_FILE}.sig" "$KO_FILE"
          if [ -f "${KO_FILE}.sig" ]; then
            echo "Signature created successfully"
            ls -lh "${KO_FILE}.sig"
          else
            echo "Error: Signature file not created!"
            exit 1
          fi

      - name: Upload hymofs_lkm.ko artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.kmi }}-arm64-hymofs-lkm
          path: |
            /github/workspace/out/${{ inputs.kmi }}_arm64_hymofs_lkm.ko
            /github/workspace/out/${{ inputs.kmi }}_arm64_hymofs_lkm.ko.sig

  build-armv7-x86_64:
    name: Build hymofs ${{ inputs.arch }} ${{ inputs.kmi }}
    if: inputs.arch == 'armv7' || inputs.arch == 'x86_64'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout YukiSU
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone HymoFS
        run: |
          git clone --depth 1 "https://github.com/Anatdx/HymoFS.git" hymofs_src
          (cd hymofs_src && git fetch --depth 1 origin "${{ inputs.hymofs_ref }}" && git checkout FETCH_HEAD 2>/dev/null || true)
          ls -la hymofs_src/src/

      - name: Generate version
        id: parse_version
        run: |
          COMMIT_NUM=$(cd hymofs_src && git rev-list --count HEAD)
          VERSION=$(echo "$COMMIT_NUM + 200" | bc)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git make clang lld llvm gcc gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi ccache \
            flex bison bc rsync cpio \
            libelf-dev libssl-dev libdw-dev pahole zip

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-hymofs-${{ inputs.kmi }}-${{ inputs.arch }}-${{ hashFiles('.github/workflows/ddk-hymofs-lkm.yml') }}
          restore-keys: |
            ccache-hymofs-${{ inputs.kmi }}-${{ inputs.arch }}-

      - name: Cache kernel tree
        uses: actions/cache@v4
        with:
          path: kernel
          key: kernel-hymofs-${{ inputs.kmi }}-${{ inputs.arch }}
          restore-keys: |
            kernel-hymofs-${{ inputs.kmi }}-

      - name: Ensure cache dirs exist
        run: mkdir -p ~/.ccache kernel

      - name: Fetch kernel tree
        run: |
          set -euo pipefail
          KMI="${{ inputs.kmi }}"
          KERNEL_SRC="$GITHUB_WORKSPACE/kernel"
          if [ ! -f "$KERNEL_SRC/Makefile" ]; then
            rm -rf "$KERNEL_SRC"
            echo "Cloning kernel tree: $KMI"
            git clone --depth=1 --branch "$KMI" https://android.googlesource.com/kernel/common "$KERNEL_SRC"
          fi
          test -f "$KERNEL_SRC/Makefile"

      - name: Setup build env (ARCH, DEFCONFIG, CROSS for 5.10)
        id: build_env
        run: |
          ARCH="${{ inputs.arch }}"
          case "$ARCH" in
            armv7)
              echo "kern_arch=arm" >> $GITHUB_OUTPUT
              echo "defconfig=multi_v7_defconfig" >> $GITHUB_OUTPUT
              echo "cross_prefix=arm-linux-gnueabi-" >> $GITHUB_OUTPUT
              ;;
            x86_64)
              echo "kern_arch=x86" >> $GITHUB_OUTPUT
              echo "defconfig=gki_defconfig" >> $GITHUB_OUTPUT
              echo "cross_prefix=" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "Unknown arch: $ARCH"
              exit 1
              ;;
          esac

      - name: Setup ccache wrapper for GCC (5.10 kernels only)
        if: inputs.kmi == 'android12-5.10' || inputs.kmi == 'android13-5.10'
        run: |
          set -euo pipefail
          WRAP_DIR="$GITHUB_WORKSPACE/.ccache_cross"
          mkdir -p "$WRAP_DIR"
          CROSS="${{ steps.build_env.outputs.cross_prefix }}"
          if [ -z "$CROSS" ]; then
            GCC_CMD="gcc"
          else
            GCC_CMD="${CROSS}gcc"
          fi
          cat > "$WRAP_DIR/gcc" << WRAPEOF
          #!/bin/bash
          args=()
          for a in "\$@"; do
            [[ "\$a" == "-r" ]] && a="--relocatable"
            args+=("\$a")
          done
          exec ccache $GCC_CMD "\${args[@]}"
          WRAPEOF
          chmod +x "$WRAP_DIR/gcc"
          if [ -z "$CROSS" ]; then
            for t in ld as ar nm objcopy objdump strip; do ln -sf "$(which $t)" "$WRAP_DIR/$t"; done
          else
            for t in ld as ar nm objcopy objdump strip; do
              ln -sf "$(which ${CROSS}$t)" "$WRAP_DIR/$t"
            done
          fi
          echo "CCACHE_CROSS_WRAP=$WRAP_DIR/" >> $GITHUB_ENV

      - name: Build hymofs_lkm.ko (manual)
        run: |
          set -euo pipefail
          KMI="${{ inputs.kmi }}"
          KERN_ARCH="${{ steps.build_env.outputs.kern_arch }}"
          DEFCONFIG="${{ steps.build_env.outputs.defconfig }}"
          KERNEL_SRC="$GITHUB_WORKSPACE/kernel"
          SRC="$GITHUB_WORKSPACE/hymofs_src/src"

          if [[ "$KMI" == android12-5.10 ]] || [[ "$KMI" == android13-5.10 ]]; then
            LLVM_ARGS=""
            CROSS_ARGS="CROSS_COMPILE=${CCACHE_CROSS_WRAP}"
          else
            LLVM_ARGS="LLVM=1 LLVM_IAS=1"
            CROSS_ARGS="CC=ccache clang"
          fi

          echo "Preparing kernel tree (KMI=$KMI, ARCH=$KERN_ARCH, defconfig=$DEFCONFIG)..."
          make -C "$KERNEL_SRC" ARCH="$KERN_ARCH" "$CROSS_ARGS" $LLVM_ARGS "$DEFCONFIG"
          if [[ "$KMI" == *"6.12"* ]] && [ -f "$KERNEL_SRC/scripts/config" ]; then
            $KERNEL_SRC/scripts/config --file "$KERNEL_SRC/.config" -d GENDWARFKSYMS 2>/dev/null || true
            make -C "$KERNEL_SRC" ARCH="$KERN_ARCH" "$CROSS_ARGS" $LLVM_ARGS olddefconfig 2>/dev/null || true
          fi
          make -C "$KERNEL_SRC" ARCH="$KERN_ARCH" "$CROSS_ARGS" $LLVM_ARGS modules_prepare

          VERSION="${{ steps.parse_version.outputs.VERSION }}"
          echo "Building hymofs_lkm.ko (v0.1.${VERSION}) for $KERN_ARCH..."
          make -C "$KERNEL_SRC" ARCH="$KERN_ARCH" "$CROSS_ARGS" $LLVM_ARGS M="$SRC" KBUILD_MODPOST_WARN=1 \
            CFLAGS_MODULE="-DHYMOFS_VERSION=\\\"0.1.${VERSION}\\\"" modules
          ls -la "$SRC"/hymofs_lkm.ko
          llvm-strip -d "$SRC"/hymofs_lkm.ko 2>/dev/null || true

      - name: Prepare .ko artifact
        run: |
          mkdir -p out
          cp hymofs_src/src/hymofs_lkm.ko "out/${{ inputs.kmi }}_${{ inputs.arch }}_hymofs_lkm.ko"
          echo "Size: $(du -h out/${{ inputs.kmi }}_${{ inputs.arch }}_hymofs_lkm.ko | cut -f1)"
          ls -la out/

      - name: Install GPG
        run: |
          sudo apt-get update && sudo apt-get install -y gnupg

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
          echo "$GPG_PRIVATE_KEY" > key.asc
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --import key.asc
          rm -f key.asc

      - name: Sign hymofs_lkm.ko with GPG
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          cd out
          KO_FILE="${{ inputs.kmi }}_${{ inputs.arch }}_hymofs_lkm.ko"
          echo "Signing $KO_FILE..."
          gpg --detach-sign --local-user an@anatdx.com --batch --yes --pinentry-mode loopback \
            --passphrase "$GPG_PASSPHRASE" \
            --output "${KO_FILE}.sig" "$KO_FILE"
          if [ -f "${KO_FILE}.sig" ]; then
            echo "Signature created successfully"
            ls -lh "${KO_FILE}.sig"
          else
            echo "Error: Signature file not created!"
            exit 1
          fi

      - name: Upload .ko
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.kmi }}-${{ inputs.arch }}-hymofs-lkm
          path: |
            out/${{ inputs.kmi }}_${{ inputs.arch }}_hymofs_lkm.ko
            out/${{ inputs.kmi }}_${{ inputs.arch }}_hymofs_lkm.ko.sig
