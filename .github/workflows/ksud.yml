name: Build ksud
on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
      os:
        required: false
        type: string
        default: ubuntu-latest
      pack_lkm:
        required: false
        type: boolean
        default: true
      pack_ksuinit:
        required: false
        type: boolean
        default: true
      use_cache:
        required: false
        type: boolean
        default: true
env:
  CARGO_TERM_COLOR: always
jobs:
  build:
    runs-on: ${{ inputs.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download artifacts
      uses: actions/download-artifact@v4
    
    - name: Prepare LKM fies
      if: ${{ inputs.pack_lkm }}
      run: |
        cp android*-lkm/*_kernelsu.ko ./userspace/ksud/bin/aarch64/
    
    - name: Prepare ksuinit
      if: ${{ inputs.pack_ksuinit }}
      run: |
        # C++ 版本: ksuinit 直接在 artifact 根目录
        # Rust 版本: ksuinit/*/release/ksuinit
        if [ -f ksuinit/ksuinit ]; then
          mv ksuinit/ksuinit ./userspace/ksud/bin/aarch64/
        else
          mv ksuinit/*/release/ksuinit ./userspace/ksud/bin/aarch64/
        fi
        
    - name: Setup rustup
      run: |
        rustup update stable
        rustup target add x86_64-apple-darwin
        rustup target add aarch64-apple-darwin

    - name: Install cross
      run: |
        RUSTFLAGS="" cargo install cross --git https://github.com/cross-rs/cross --rev 66845c1

    - name: Build ksud
      run: CROSS_NO_WARNINGS=0 cross build --target ${{ inputs.target }} --release --manifest-path ./userspace/ksud/Cargo.toml

    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        fingerprint: "348C368D028B3271B84EB798AD251FCA1EBBCEEE"
        trust_level: 5

    - name: Sign ksud with GPG
      run: |
        KSUD_FILE=$(find userspace/ksud/target -type f -name "ksud" -path "*/release/*" | head -n 1)
        if [ -f "$KSUD_FILE" ]; then
          echo "Signing $KSUD_FILE..."
          gpg --detach-sign --local-user an@anatdx.com --batch --yes --pinentry-mode loopback \
            --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
            --output "${KSUD_FILE}.sig" "$KSUD_FILE"
          if [ -f "${KSUD_FILE}.sig" ]; then
            echo "Signature created successfully"
            ls -lh "${KSUD_FILE}.sig"
          else
            echo "Error: Signature file not created!"
            exit 1
          fi
        fi

    - name: Upload ksud artifact
      uses: actions/upload-artifact@v4
      with:
        name: ksud-${{ inputs.target }}
        path: |
          userspace/ksud/target/**/release/ksud
          userspace/ksud/target/**/release/ksud.sig
