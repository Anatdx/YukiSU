menu "KernelSU"

config KSU
	  tristate "KernelSU function support"
	  default y
	  help
		Enable kernel-level root privileges on Android System.
		To compile as a module, choose M here: the
		module will be called kernelsu.

config KSU_DEBUG
	  bool "KernelSU debug mode"
	  depends on KSU
	  default n
	  help
		Enable KernelSU debug mode.

config KSU_ALLOWLIST_WORKAROUND
	bool "KernelSU Session Keyring Init workaround"
	depends on KSU
	default n
	help
	  Enable session keyring init workaround for problematic devices.
	  Useful for situations where the SU allowlist is not kept after a reboot

config KSU_MANUAL_SU
	bool "Use manual su"
	depends on KSU
	default y
	help
	  Use manual su and authorize the corresponding command line and application via fd

config KSU_MANUAL_HOOK
	bool "Hook KernelSU manually"
	depends on KSU != m
	help
	  If enabled, Hook required KernelSU syscalls with manually-patched function.
	  
	  When using manual hooks, you need to apply kernel patches to hook:
	  - fs/exec.c: ksu_handle_execveat
	  - fs/open.c: ksu_handle_faccessat
	  - fs/stat.c: ksu_handle_stat, ksu_handle_newfstat_ret (optional)
	  - kernel/reboot.c: ksu_handle_sys_reboot
	  
	  See YukiSU_patch/scope_min_manual_hooks_v1.9.patch for reference.

config KSU_MANUAL_HOOK_INTEGRITY_CHECK
	bool "Enable manual hook integrity check"
	depends on KSU_MANUAL_HOOK
	default y
	help
	  Perform compile-time checks to ensure all required manual hooks
	  are properly implemented. This helps catch integration errors early.
	  
	  If enabled and hooks are missing, compilation will fail with clear
	  error messages indicating which hooks need to be added.
	  
	  Advanced users who know what they're doing can disable this check,
	  but it's STRONGLY RECOMMENDED to keep it enabled to avoid runtime
	  issues and security vulnerabilities.
	  
	  Inspired by ReSukiSU's strict checking approach, but made optional
	  for flexibility.

config KSU_MANUAL_HOOK_AUTO_SETUID_HOOK
	bool "Automatically hook setuid by lsm"
	depends on KSU_MANUAL_HOOK
	default y
	help
	  If turn off this option, you need checkout to kernel/sys.c 
	  in SYSCALL_DEFINE3(setresuid, uid_t, ruid, uid_t, euid, uid_t, suid)
	  add a ksu_handle_setresuid calls in there
	  
	  For kernels 6.8+, LSM hook is automatically available.
	  For older kernels (< 6.8), you must manually patch kernel/sys.c.

config KSU_TAMPER_SYSCALL_TABLE
	bool "Tamper syscall table for sucompat (EXPERIMENTAL)"
	depends on KSU_MANUAL_HOOK
	default n
	help
	  Enable syscall table tampering to hook sucompat syscalls directly.
	  This backports the feature from scope-minimized manual hooks v1.8+.
	  
	  When enabled, this allows skipping manual hooks for:
	  - sys_execve
	  - sys_faccessat
	  - sys_newfstatat
	  - sys_newfstat (return hook)
	  - sys_reboot (if kprobe unavailable)
	  
	  Compatibility:
	  - 3.10~4.19 kernels: >95% success rate
	  - 5.4~6.1 kernels: ~67% success rate
	  
	  WARNING: This is experimental and may not work on all kernels.
	  Only enable if you cannot use standard hooks.

config KSU_KRETPROBES_SUCOMPAT
	bool "Use kretprobes for getname_flags sucompat (EXPERIMENTAL)"
	depends on KRETPROBES && !KSU_TAMPER_SYSCALL_TABLE
	default n
	help
	  Hook getname_flags() via kretprobe to implement sucompat.
	  This is the most stealthy method and improves reliability.
	  
	  Advantages:
	  - Prevents timing-based detection (newfstat vs newfstatat)
	  - No usercopy operations, more reliable on page faults
	  - Defeats anti-root detection techniques:
	    * Delayed syscall detection
	    * KSU (ND) detection
	    * sucompat SCA (Disclosure)
	    * Abnormal Environment (NT)
	  
	  WARNING: This is very experimental. Default to N.
	  Requires CONFIG_KRETPROBES=y in kernel config.

config KSU_LKM
	bool "Build as Loadable Kernel Module (LKM)"
	depends on KSU = m
	default y if KSU = m
	help
	  Enable LKM-specific features:
	  - GKI yield support (LKM can take over from built-in KSU)
	  - Delayed manager search on module load
	  - kallsyms-based symbol lookup for GKI coexistence
	  
	  This is automatically enabled when KSU is built as a module (=m).
	  When building KSU into the kernel (=y), this should be disabled.

config KSU_SUPERKEY
	bool "Enable SuperKey authentication"
	depends on KSU
	default y
	help
	  Enable APatch-style SuperKey authentication.
	  This allows the manager app to authenticate using a password
	  instead of APK signature verification.
	  
	  The SuperKey can be set at compile time via KSU_SUPERKEY="your_key"
	  or patched into the LKM binary by ksud.

endmenu
